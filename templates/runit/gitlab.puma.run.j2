#!/bin/bash
#
# Generated by Ansible
# Local modification will be overwritten.
#

# Settings
APP_ROOT={{ gitlab_web_base_dir.path }}
APP_USER={{ gitlab_git_user.name }}
APP_GROUP={{ gitlab_deploy_user.name }}
APP_RAILS_ENV='{{ gitlab_env }}'

PUMA_CONFIG="$APP_ROOT/current/config/puma.rb"
CMD="bundle exec puma -C $PUMA_CONFIG"
CHPSTKEY="-u ${APP_USER}:${APP_GROUP}"


# Set environment variables
export RAILS_ENV=$APP_RAILS_ENV
export PUMA_PORT={{ item.port }}
export PUMA_WORKERS={{ item.workers }}
export PUMA_BACKLOG={{ item.backlog }}
export PATH={{ rbenv_root }}/bin:$PATH

cd ${APP_ROOT}/current

# Run
exec 2>&1
echo "Running gitlab api web server..."
exec chpst $CHPSTKEY $CMD
